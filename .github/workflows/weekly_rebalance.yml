name: Weekly Rebalance

on:
  schedule:
    - cron: '0 9 * * 1'  # Pondělí 9:00 UTC
  workflow_dispatch:  # Manuální trigger

jobs:
  rebalance:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    - name: Install dependencies
      run: pip install -r requirements.txt
    - name: Run Screening & RL
      env:
        POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      run: |
        python -c "
        from src.screener import Screener
        from src.rl_agent import QLearningAgent
        from datetime import datetime, timedelta
        screener = Screener('$POLYGON_API_KEY')
        agent = QLearningAgent()
        end = datetime.now().strftime('%Y-%m-%d')
        start = (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d')
        screened = screener.screen(start, end)
        picks = agent.rebalance(screened)
        agent.learn_from_past()
        print('Rebalanced picks:', picks)
        "
    - name: Commit History
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/
        git commit -m "Weekly rebalance update" || exit 0
        git push
